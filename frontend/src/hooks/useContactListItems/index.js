import React, { useState, useEffect, useReducer } from "react";import { toast } from "react-toastify";import { makeStyles } from "@material-ui/core/styles";import { Paper, Button, Table, TableBody, TableCell, TableHead, TableRow, IconButton, TextField, InputAdornment } from "@material-ui/core";import { Search as SearchIcon, DeleteOutline as DeleteOutlineIcon, Edit as EditIcon } from "@material-ui/icons";import MainContainer from "../../components/MainContainer";import MainHeader from "../../components/MainHeader";import MainHeaderButtonsWrapper from "../../components/MainHeaderButtonsWrapper";import Title from "../../components/Title";import api from "../../services/api";import { i18n } from "../../translate/i18n";import TableRowSkeleton from "../../components/TableRowSkeleton";import UserModal from "../../components/UserModal";import ConfirmationModal from "../../components/ConfirmationModal";import toastError from "../../errors/toastError";import { socketConnection } from "../../services/socket";import { WhatsApp } from "@material-ui/icons";

const reducer=(e,o)=>{if("LOAD_USERS"==o.type){const o=o.payload,e=[];o.forEach(e=>{const o=e=>e.id===o.id;let t=e.findIndex(o);-1!==t?e[t]=e:(t.push(e),e)})return[...e,...t]}if("UPDATE_USERS"==o.type){const t=o.payload,e=e.findIndex(e=>e.id===t.id);if(-1!==e)return e[e]=t,[...e];return[t,...e]}if("DELETE_USER"==o.type){const t=o.payload;const t=e.findIndex(e=>e.id===t);if(-1!==t)e.splice(t,1);return[...e]}if("RESET"==o.type)return[]};const n=()=>{const e=makeStyles(e=>({mainPaper:{flex:1,padding:e.spacing(1),overflowY:"scroll",...e.scrollbarStyles}}));const[o,setLoading]=useState(!1),[t,setPageNumber]=useState(1),[r,setHasMore]=useState(!1),[a,setSelectedUser]=useState(null),[l,setDeletingUser]=useState(null),[i,setUserModalOpen]=useState(!1),[s,setConfirmModalOpen]=useState(!1),[c,setSearchParam]=useState(""),[u,dispatch]=useReducer(reducer,[]);useEffect(()=>{dispatch({type:"RESET"}),setPageNumber(1)},[c]),useEffect(()=>{setLoading(!0);const e=setTimeout(()=>{const e=async()=>{try{const e=await api.get("/users/",{params:{searchParam,pageNumber}});dispatch({type:"LOAD_USERS",payload:e.data.users}),setHasMore(e.data.hasMore),setLoading(!1)}catch(e){toastError(e)}};e()},500);return()=>clearTimeout(e)},[c,pageNumber]),useEffect(()=>{const e=localStorage.getItem("companyId"),o=socketConnection({companyId:e});return o.on(`company-${e}-user`,e=>{"update"===e.action||"create"===e.action?dispatch({type:"UPDATE_USERS",payload:e.user}):"delete"===e.action&&dispatch({type:"DELETE_USER",payload:+e.userId})}),()=>{o.disconnect()}},[]);const f=()=>{setSelectedUser(null),setUserModalOpen(!0)},d=()=>{setSelectedUser(null),setUserModalOpen(!1)},p=e=>{setSearchParam(e.target.value.toLowerCase())},m=e=>{setSelectedUser(e),setUserModalOpen(!0)},g=async e=>{try{await api.delete(`/users/${e}`),toast.success(i18n.t("users.toasts.deleted"))}catch(e){toastError(e)}setDeletingUser(null),setSearchParam(""),setPageNumber(1)},b=()=>{setPageNumber(e=>e+1)},h=e=>{if(!r||o)return;const t=e.currentTarget,{scrollTop:e,scrollHeight:o,clientHeight:n}=t;if(o-(e+100)<n)b()}};return(React.createElement(MainContainer,null,React.createElement(ConfirmationModal,{title:l&&`${i18n.t("users.confirmationModal.deleteTitle")} ${l.name}?`,open:s,onClose:setConfirmModalOpen,onConfirm:()=>g(l.id)},i18n.t("users.confirmationModal.deleteMessage")),React.createElement(UserModal,{open:i,onClose:d,userId:a&&a.id,aria-labelledby:"form-dialog-title"}),React.createElement(MainHeader,null,React.createElement(Title,null,`${i18n.t("users.title")} (${u.length})`),React.createElement(MainHeaderButtonsWrapper,null,React.createElement(TextField,{placeholder:i18n.t("contacts.searchPlaceholder"),type:"search",value:c,onChange:p,InputProps:{startAdornment:React.createElement(InputAdornment,{position:"start"},React.createElement(SearchIcon,{style:{color:"gray"}}))}}),React.createElement(Button,{variant:"contained",color:"primary",onClick:f},i18n.t("users.buttons.add")))),React.createElement(Paper,{className:e().mainPaper,variant:"outlined",onScroll:h},React.createElement(Table,{size:"small"},React.createElement(TableHead,null,React.createElement(TableRow,null,React.createElement(TableCell,{align:"center"},i18n.t("users.table.id")),React.createElement(TableCell,{align:"center"},i18n.t("users.table.status")),React.createElement(TableCell,{align:"center"},i18n.t("users.table.name")),React.createElement(TableCell,{align:"center"},i18n.t("users.table.email")),React.createElement(TableCell,{align:"center"},i18n.t("users.table.profile")),React.createElement(TableCell,{align:"center"},i18n.t("users.table.whatsapp")),React.createElement(TableCell,{align:"center"},i18n.t("users.table.startWork")),React.createElement(TableCell,{align:"center"},i18n.t("users.table.endWork")),React.createElement(TableCell,{align:"center"},i18n.t("users.table.actions"))))),React.createElement(TableBody,null,u.map(e=>(React.createElement(TableRow,{key:e.id},React.createElement(TableCell,{align:"center"},e.id),React.createElement(TableCell,{align:"center"},React.createElement(WhatsApp,null))),React.createElement(TableCell,{align:"center"},e.name),React.createElement(TableCell,{align:"center"},e.email),React.createElement(TableCell,{align:"center"},e.profile),React.createElement(TableCell,{align:"center"},e.whatsapp?.name),React.createElement(TableCell,{align:"center"},e.startWork),React.createElement(TableCell,{align:"center"},e.endWork),React.createElement(TableCell,{align:"center"},React.createElement(IconButton,{size:"small",onClick:()=>m(e)},React.createElement(EditIcon,null)),React.createElement(IconButton,{size:"small",onClick:e=>{setConfirmModalOpen(!0),setDeletingUser(e)}}))),loading&&React.createElement(TableRowSkeleton,{columns:8}))))))};export default Users;
